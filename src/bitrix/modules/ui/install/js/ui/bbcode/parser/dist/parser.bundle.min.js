this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};(function(e,t,n){"use strict";class s extends n.BBCodeScheme{getTagScheme(e){return new n.BBCodeTagScheme({name:"any"})}isAllowedTag(e){return true}}const i=/\[(\/)?(\w+|\*)([\s\w"'./:=]+)?]/gs;const r=e=>["\n","\t"].includes(e);const a=e=>["list","ul","ol"].includes(e);const l=e=>["*","li"].includes(e);const c=new s;class o{constructor(e={}){if(e.scheme){this.setScheme(e.scheme)}else{this.setScheme(new n.DefaultBBCodeScheme)}if(t.Type.isFunction(e.onUnknown)){this.setOnUnknown(e.onUnknown)}else{this.setOnUnknown(o.defaultOnUnknownHandler)}}setScheme(e){this.scheme=e}getScheme(){return this.scheme}setOnUnknown(e){if(!t.Type.isFunction(e)){throw new TypeError("handler is not a function")}this.onUnknownHandler=e}getOnUnknownHandler(){return this.onUnknownHandler}static defaultOnUnknownHandler(e,t){if(e.getType()===n.BBCodeNode.ELEMENT_NODE){const n=e.getOpeningTag();const s=e.getClosingTag();e.replace(t.createText(n),...e.getChildren(),t.createText(s))}}static toLowerCase(e){if(t.Type.isStringFilled(e)){return e.toLowerCase()}return e}parseText(e){if(t.Type.isStringFilled(e)){return[...e].reduce(((e,n)=>{if(r(n)){e.push(n)}else{const s=e.at(-1);if(r(s)||t.Type.isNil(s)){e.push(n)}else{e[e.length-1]+=n}}return e}),[]).map((e=>{if(e==="\n"){return c.createNewLine()}if(e==="\t"){return c.createTab()}return c.createText({content:e})}))}return[]}static findNextTagIndex(e,t=0){const n=e.slice(t);const[s]=n.match(new RegExp(i))||[];if(s){return e.indexOf(s,t)}return-1}static trimQuotes(e){const t=String(e);if(/^["'].*["']$/g.test(t)){return t.slice(1,-1)}return e}parseAttributes(e){const n={value:"",attributes:[]};if(t.Type.isStringFilled(e)){if(e.startsWith("=")){n.value=o.trimQuotes(e.slice(1));return n}return e.trim().split(" ").filter(Boolean).reduce(((e,t)=>{const[n,s=""]=t.split("=");e.attributes.push([o.toLowerCase(n),o.trimQuotes(s)]);return e}),n)}return n}parse(e){const t=c.createRoot();const s=[];let r=null;let h=-1;const d=o.findNextTagIndex(e);if(d!==0){const n=d===-1?e:e.slice(0,d);t.appendChild(...this.parseText(n))}e.replace(i,((n,i,d,u,f)=>{const g=Boolean(i)===false;const p=n.length+f;const m=e.slice(p);const T=this.parseAttributes(u);const C=o.toLowerCase(d);let w=null;if(g){h++;if(m.includes(`[/${d}]`)||l(C)){r=c.createElement({name:C,value:T.value,attributes:Object.fromEntries(T.attributes)});const t=o.findNextTagIndex(e,p);if(t!==0){const n=t===-1?m:e.slice(p,t);r.appendChild(...this.parseText(n))}}else{const e=this.getScheme().getTagScheme(C);if(e.isVoid()){r=c.createElement({name:C,value:T.value,attributes:Object.fromEntries(T.attributes)});r.setScheme(this.getScheme())}else{r=c.createText(n)}}if(h===0){t.appendChild(r)}w=s[h-1];if(a(r.getName())){if(w&&a(w.getName())){s[h].appendChild(r)}else if(w){w.appendChild(r)}}else if(w&&a(w.getName())&&!l(r.getName())){const e=w.getChildren().at(-1);if(e){e.appendChild(r)}}else if(w){w.appendChild(r)}s[h]=r;if(l(C)&&h>-1){h--;r=h===-1?t:s[h]}}if(r.getName()==="#text"){h--}if(!g||r.getName()==="#text"||r.isVoid()){if(h>-1&&r.getName()===C){h--;r=h===-1?t:s[h]}const n=o.findNextTagIndex(e,p);if(n!==p){w=h===-1?t:s[h];const i=e.slice(p,n===-1?undefined:n);if(a(w.getName())){const e=w.getChildren().at(-1);if(e){e.appendChild(...this.parseText(i))}}else{w.appendChild(...this.parseText(i))}}}}));const u=e=>{let t=false;return e.getChildren().reduceRight(((e,n,s)=>{if(!t&&n.getName()==="#linebreak"){e.push(s)}else if(!t&&n.getName()!=="#tab"){t=true}return e}),[])};n.BBCodeNode.flattenAst(t).forEach((e=>{if(e.getName()==="*"){const t=u(e);if(t.length===1){e.setChildren(e.getChildren().slice(0,t.at(0)))}if(t.length>1&&(t&2)===0){e.setChildren(e.getChildren().slice(0,t.at(0)))}}}));t.setScheme(this.getScheme(),this.getOnUnknownHandler());return t}}e.BBCodeParser=o})(this.BX.UI.Bbcode=this.BX.UI.Bbcode||{},BX,BX.UI.Bbcode);
//# sourceMappingURL=parser.bundle.map.js